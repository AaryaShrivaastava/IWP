<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy-First Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            height: 40vh;
            width: 80vw;
            max-width: 800px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="app" class="min-h-screen p-8 flex flex-col items-center">
        <!-- Dashboard Header -->
        <header class="w-full max-w-4xl text-center mb-8">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-bold text-gray-900 mb-2">Privacy-First Analytics</h1>
            <p class="text-md sm:text-lg text-gray-600">Secure and anonymous website insights.</p>
        </header>

        <!-- Main Content Area -->
        <main class="w-full max-w-4xl bg-white rounded-lg shadow-xl p-6 md:p-10 mb-8">
            <!-- User ID Display for collaborative environment -->
            <div class="mb-6 bg-gray-50 border border-gray-200 p-4 rounded-lg text-sm text-gray-600">
                <span class="font-bold">Your User ID:</span> <span id="userIdDisplay">Loading...</span>
            </div>

            <div id="loading" class="flex flex-col items-center justify-center py-20 text-gray-500">
                <svg class="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-4">Fetching analytics data...</p>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboard-content" class="hidden">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-8">
                    <!-- Total Views Card -->
                    <div class="bg-gray-50 rounded-lg p-6 text-center shadow-sm">
                        <p class="text-sm font-medium text-gray-500">Total Site Views</p>
                        <p id="totalViews" class="text-4xl font-bold text-gray-900 mt-2">0</p>
                    </div>

                    <!-- Most Visited Page Card -->
                    <div class="bg-gray-50 rounded-lg p-6 text-center shadow-sm">
                        <p class="text-sm font-medium text-gray-500">Most Visited Page</p>
                        <p id="mostVisited" class="text-lg font-bold text-gray-900 mt-2 truncate">/loading...</p>
                    </div>
                </div>

                <!-- Page Views Chart -->
                <div class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Page Views by Path</h2>
                    <div class="flex justify-center">
                        <div class="chart-container">
                            <canvas id="pageViewsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Live Data Table -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">Detailed Page Views</h2>
                    <div class="overflow-x-auto rounded-lg">
                        <table class="min-w-full bg-gray-50 rounded-lg">
                            <thead>
                                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                    <th class="py-3 px-6 text-left">Page Path</th>
                                    <th class="py-3 px-6 text-center">Views</th>
                                </tr>
                            </thead>
                            <tbody id="pageViewsTableBody" class="text-gray-600 text-sm font-light">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="hidden text-center text-red-500 mt-8">
                <p>Failed to load data. Please check your Firebase configuration and network connection.</p>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore, doc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      
      setLogLevel('debug');
      
      const firebaseConfig = JSON.parse('{"apiKey":"AIzaSyD-x_...","authDomain":"your-project-id.firebaseapp.com","projectId":"your-project-id","storageBucket":"your-project-id.appspot.com","messagingSenderId":"123456789012","appId":"1:123456789012:web:a1b2c3d4e5f6g7h8i9j0k1"}');
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const firebaseConfigWithProjectId = { ...firebaseConfig, projectId: appId };
      
      // Initialize Firebase
      const app = initializeApp(firebaseConfigWithProjectId);
      const db = getFirestore(app);
      const auth = getAuth(app);
      
      let chartInstance = null;
      let isAuthReady = false;

      // Handle authentication
      async function handleAuth() {
        try {
          const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
          if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
          } else {
            await signInAnonymously(auth);
          }
          isAuthReady = true;
          document.getElementById('userIdDisplay').textContent = auth.currentUser?.uid || 'Anonymous User';
          console.log('Authentication successful. User ID:', auth.currentUser?.uid);
          // Start listening for data after authentication is ready
          setupFirestoreListener();
        } catch (error) {
          console.error("Firebase Auth Error:", error);
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('error-message').classList.remove('hidden');
        }
      }

      // Setup Firestore real-time listener
      function setupFirestoreListener() {
        if (!isAuthReady) return;

        const collection_path = `artifacts/${appId}/public/data/analytics`;
        const docRef = doc(db, collection_path, 'page_views');

        onSnapshot(docRef, (doc) => {
          document.getElementById('loading').classList.add('hidden');
          if (doc.exists()) {
            const data = doc.data();
            console.log("Current data: ", data);
            updateDashboard(data);
            document.getElementById('dashboard-content').classList.remove('hidden');
          } else {
            console.log("No data available yet.");
            updateDashboard({});
            document.getElementById('dashboard-content').classList.remove('hidden');
          }
        }, (error) => {
          console.error("Firestore Error:", error);
          document.getElementById('loading').classList.add('hidden');
          document.getElementById('error-message').classList.remove('hidden');
        });
      }

      // Update the dashboard UI
      function updateDashboard(data) {
        let totalViews = data.total_views || 0;
        let mostVisitedPath = 'N/A';
        let maxViews = 0;
        const pageViews = {};
        
        for (const key in data) {
          if (key !== 'total_views') {
            const views = data[key];
            pageViews[key] = views;
            if (views > maxViews) {
              maxViews = views;
              mostVisitedPath = key;
            }
          }
        }

        document.getElementById('totalViews').textContent = totalViews.toLocaleString();
        document.getElementById('mostVisited').textContent = mostVisitedPath;
        
        // Update the table
        const tableBody = document.getElementById('pageViewsTableBody');
        tableBody.innerHTML = '';
        const sortedPaths = Object.keys(pageViews).sort((a, b) => pageViews[b] - pageViews[a]);
        
        sortedPaths.forEach(path => {
          const row = `
            <tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6 text-left whitespace-nowrap">${path}</td>
                <td class="py-3 px-6 text-center">${pageViews[path].toLocaleString()}</td>
            </tr>
          `;
          tableBody.innerHTML += row;
        });

        // Update the chart
        updateChart(sortedPaths, sortedPaths.map(path => pageViews[path]));
      }

      // Update the Chart.js visualization
      function updateChart(labels, data) {
        const ctx = document.getElementById('pageViewsChart').getContext('2d');
        if (chartInstance) {
          chartInstance.destroy();
        }
        
        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Views',
              data: data,
              backgroundColor: 'rgba(59, 130, 246, 0.6)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 1,
              borderRadius: 8,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  display: false
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  autoSkip: false,
                  maxRotation: 45,
                  minRotation: 0
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    if (context.parsed.y !== null) {
                      label += new Intl.NumberFormat().format(context.parsed.y);
                    }
                    return label;
                  }
                }
              }
            }
          }
        });
      }

      // Start the application
      window.onload = handleAuth;
    </script>
</body>
</html>
